<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Builder Dashboard | Enerlytics</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .dashboard-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header h1 {
        color: #667eea;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .builder-badge {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 10px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-name {
        font-weight: 600;
        color: #555;
      }

      .logout-btn {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #667eea, #764ba2);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .stat-card.users::before {
        background: linear-gradient(90deg, #fa709a, #fee140);
      }

      .stat-card.devices::before {
        background: linear-gradient(90deg, #4facfe, #00f2fe);
      }

      .stat-card.energy::before {
        background: linear-gradient(90deg, #43e97b, #38f9d7);
      }

      .stat-card.cost::before {
        background: linear-gradient(90deg, #f093fb, #f5576c);
      }

      .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.8;
      }

      .stat-card.users .stat-icon {
        color: #fee140;
      }

      .stat-card.devices .stat-icon {
        color: #00f2fe;
      }

      .stat-card.energy .stat-icon {
        color: #38f9d7;
      }

      .stat-card.cost .stat-icon {
        color: #f5576c;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
      }

      .stat-unit {
        font-size: 1rem;
        color: #999;
        font-weight: 400;
      }

      /* Charts Section */
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .chart-card.full-width {
        grid-column: 1 / -1;
      }

      .chart-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      .chart-container.tall {
        height: 400px;
      }

      /* Users Table */
      .users-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .users-table {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background-color: #f8f9ff;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .badge-high {
        background: #f8d7da;
        color: #721c24;
      }

      .badge-medium {
        background: #fff3cd;
        color: #856404;
      }

      .badge-low {
        background: #d4edda;
        color: #155724;
      }

      /* Footer */
      footer {
        text-align: center;
        padding: 20px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .chart-card.full-width {
          grid-column: 1;
        }

        header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header>
        <h1>
          <i class="fas fa-building"></i> Builder Dashboard
          <span class="builder-badge">BUILDER</span>
        </h1>
        <div class="user-info">
          <span class="user-name"><i class="fas fa-user-circle"></i> <%= builder.name %></span>
          <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </header>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card users">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-label">Total Residents</div>
          <div class="stat-value">
            <%= totalUsers %><span class="stat-unit"> users</span>
          </div>
        </div>

        <div class="stat-card devices">
          <div class="stat-icon"><i class="fas fa-microchip"></i></div>
          <div class="stat-label">Total Devices</div>
          <div class="stat-value">
            <%= totalDevices %><span class="stat-unit"> devices</span>
          </div>
        </div>

        <div class="stat-card energy">
          <div class="stat-icon"><i class="fas fa-battery-three-quarters"></i></div>
          <div class="stat-label">Today's Total Energy</div>
          <div class="stat-value">
            <%= totalTodayEnergy %><span class="stat-unit"> kWh</span>
          </div>
        </div>

        <div class="stat-card cost">
          <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
          <div class="stat-label">Today's Total Cost</div>
          <div class="stat-value">
            â‚¹<span class="stat-unit"><%= totalTodayCost %></span>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="charts-grid">
        <!-- Building Energy Usage Over Time -->
        <div class="chart-card full-width">
          <div class="chart-title">
            <i class="fas fa-chart-line"></i> Building Energy Usage (Last 7 Days)
          </div>
          <div class="chart-container tall">
            <canvas id="energyTimeChart"></canvas>
          </div>
        </div>

        <!-- Monthly Comparison -->
        <div class="chart-card">
          <div class="chart-title">
            <i class="fas fa-chart-area"></i> Monthly Comparison
          </div>
          <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>

        <!-- Daily Cost Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <i class="fas fa-chart-bar"></i> Daily Cost (Last 7 Days)
          </div>
          <div class="chart-container">
            <canvas id="costChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Users Consumption Table -->
      <div class="users-section">
        <div class="section-title">
          <i class="fas fa-list"></i> Residents Energy Consumption
        </div>
        <div class="users-table">
          <table>
            <thead>
              <tr>
                <th><i class="fas fa-user"></i> Resident Name</th>
                <th><i class="fas fa-envelope"></i> Email</th>
                <th><i class="fas fa-map-marker-alt"></i> Address</th>
                <th><i class="fas fa-microchip"></i> Devices</th>
                <th><i class="fas fa-battery-half"></i> Daily Energy (kWh)</th>
                <th><i class="fas fa-rupee-sign"></i> Daily Cost (â‚¹)</th>
              </tr>
            </thead>
            <tbody>
              <% if (!userConsumption || userConsumption.length === 0) { %>
              <tr>
                <td colspan="6" style="text-align: center; color: #999; padding: 30px;">
                  No residents found in the building
                </td>
              </tr>
              <% } else { %>
                <% userConsumption.forEach(user => { %>
                <tr>
                  <td><strong><%= user.name %></strong></td>
                  <td><%= user.email %></td>
                  <td><%= user.address %></td>
                  <td><%= user.deviceCount %></td>
                  <td>
                    <span class="badge <%= user.dailyEnergy > 20 ? 'badge-high' : (user.dailyEnergy > 10 ? 'badge-medium' : 'badge-low') %>">
                      <%= user.dailyEnergy %> kWh
                    </span>
                  </td>
                  <td><strong>â‚¹<%= user.dailyCost %></strong></td>
                </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer>
      Enerlytics Builder Dashboard Â© 2025 | Building Energy Management ðŸŒ±
    </footer>

    <script>
      // Prepare data from server
      const dailyData = <%- JSON.stringify(dailyData || []) %>;
      const currentMonthEnergy = <%= parseFloat(currentMonthEnergy) || 0 %>;
      const lastMonthEnergy = <%= parseFloat(lastMonthEnergy) || 0 %>;
      const currentMonthCost = <%= parseFloat(currentMonthCost) || 0 %>;
      const lastMonthCost = <%= parseFloat(lastMonthCost) || 0 %>;

      // Chart.js default configuration
      Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
      Chart.defaults.font.size = 12;
      Chart.defaults.color = '#666';

      // Helper functions
      function safeDate(dateStr) {
        try {
          return new Date(dateStr);
        } catch (e) {
          return new Date();
        }
      }

      function safeNumber(val) {
        const num = parseFloat(val);
        return isNaN(num) ? 0 : num;
      }

      // 1. Energy Usage Over Time (7 Days)
      const energyTimeCtx = document.getElementById('energyTimeChart');
      if (energyTimeCtx) {
        const timeLabels = dailyData.map(day => {
          const date = safeDate(day.date);
          return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        });
        
        const energyData = dailyData.map(day => safeNumber(day.energy));

        new Chart(energyTimeCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [{
              label: 'Building Energy Usage (kWh)',
              data: energyData,
              borderColor: 'rgb(102, 126, 234)',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointBackgroundColor: 'rgb(102, 126, 234)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    return `Energy: ${safeNumber(context.parsed.y).toFixed(2)} kWh`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  callback: function(value) {
                    return safeNumber(value).toFixed(1) + ' kWh';
                  }
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // 2. Monthly Comparison
      const monthlyCtx = document.getElementById('monthlyChart');
      if (monthlyCtx) {
        new Chart(monthlyCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Last Month', 'Current Month'],
            datasets: [
              {
                label: 'Energy (kWh)',
                data: [safeNumber(lastMonthEnergy), safeNumber(currentMonthEnergy)],
                backgroundColor: ['rgba(250, 112, 154, 0.8)', 'rgba(79, 172, 254, 0.8)'],
                borderColor: ['rgba(250, 112, 154, 1)', 'rgba(79, 172, 254, 1)'],
                borderWidth: 2,
                borderRadius: 8,
                yAxisID: 'y',
              },
              {
                label: 'Cost (â‚¹)',
                data: [safeNumber(lastMonthCost), safeNumber(currentMonthCost)],
                backgroundColor: ['rgba(254, 224, 64, 0.8)', 'rgba(67, 233, 123, 0.8)'],
                borderColor: ['rgba(254, 224, 64, 1)', 'rgba(67, 233, 123, 1)'],
                borderWidth: 2,
                borderRadius: 8,
                yAxisID: 'y1',
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
              }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Energy (kWh)'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Cost (â‚¹)'
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // 3. Daily Cost Chart
      const costCtx = document.getElementById('costChart');
      if (costCtx) {
        const costLabels = dailyData.map(day => {
          const date = safeDate(day.date);
          return date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
        });
        
        const costData = dailyData.map(day => safeNumber(day.cost));

        new Chart(costCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: costLabels,
            datasets: [{
              label: 'Daily Cost (â‚¹)',
              data: costData,
              backgroundColor: 'rgba(67, 233, 123, 0.8)',
              borderColor: 'rgba(67, 233, 123, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    return `Cost: â‚¹${safeNumber(context.parsed.y).toFixed(2)}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  callback: function(value) {
                    return 'â‚¹' + safeNumber(value).toFixed(0);
                  }
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
    </script>
  </body>
</html>
